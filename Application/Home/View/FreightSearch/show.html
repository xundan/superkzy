<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
    <meta name="viewport"
          content="width=device-width,initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge，chrome=1">
    <!--<link rel="icon" href="../../favicon.ico">-->
    <title>运费查询</title>
    <link type="text/css" rel="stylesheet" href="__PUBLIC__/home/css/bootstrap.min.css"/>
    <link type="text/css" rel="stylesheet" href="__PUBLIC__/home/css/weui.min.css"/>
    <link type="text/css" rel="stylesheet" href="__PUBLIC__/home/css/mycss.css"/>
    <link type="text/css" rel="stylesheet" href="__PUBLIC__/home/css/city-picker.css"/>
    <script type="text/javascript" src="__PUBLIC__/home/js/jquery-2.2.4.min.js"></script>
    <script type="text/javascript" src="__PUBLIC__/home/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="__PUBLIC__/home/js/cookie.js"></script>
    <script type="text/javascript" src="__PUBLIC__/home/js/iscroll4.js"></script>
    <script type="text/javascript" src="__PUBLIC__/home/js/ck_log.js"></script>
    <script type="text/javascript" src="__PUBLIC__/home/js/city-picker.data.js"></script>
    <script type="text/javascript" src="__PUBLIC__/home/js/city-picker-search.js"></script>
    <script type="text/javascript" src="__PUBLIC__/home/js/loading.js"></script>
</head>
<body>
<include file="Common:common"/>
<!--标签隐藏表单提交-->
<form name="tag_search" id="tag_search">
    <input type="hidden" name="area_start">
    <input type="hidden" name="area_start_name">
    <input type="hidden" name="area_start_val">
    <input type="hidden" name="area_end">
    <input type="hidden" name="area_end_name">
    <input type="hidden" name="area_end_val">
    <input type="hidden" name="page" id="page" value="1">
</form>
<!--导航标签-->
<!--<div class="panel-title" style="height: 50px;background-color: white;display: block;">-->
    <!--<div id="myTab" class="row" style="height: 100%;">-->
        <!--<div class="text-center col-xs-5" id="area_start_click" style="line-height: 40px;color: black;font-size: 1.2em;padding: 5px 0;font-weight: 100">-->
            <!--<img src="__PUBLIC__/home/images/area_start_text.png" class="" style="height: 20px">-->
            <!--<span id="area_start_html">点击选择</span>-->
            <!--&lt;!&ndash;<span id="area_start_remove" class="" style="font-size:1em;color:darkgrey">X</span>&ndash;&gt;-->
            <!--&lt;!&ndash;<span class="weui_icon_clear_no_circle" style="color: black"></span>&ndash;&gt;-->
            <!--<span id="area_start_remove" style="line-height: 40px">-->
                <!--&lt;!&ndash;<img src="__PUBLIC__/home/images/remove.png" style="position: absolute;right: 0;top:33%;width: 1em">&ndash;&gt;-->
                <!--<img src="__PUBLIC__/home/images/remove.png" style="margin-top: -4px;width: 1em">-->
            <!--</span>-->
            <!--&lt;!&ndash;<a href="javascript:" class="weui_icon_clear" id="search_clear"></a>&ndash;&gt;-->
            <!--<div id="area_start" style="display: none"></div>-->
        <!--</div>-->
        <!--<div class="text-center col-xs-2" style="line-height: 40px;color: black;padding: 5px 0;">-->
            <!--&lt;!&ndash;<hr style="border-color: red;width: 10%;margin: 16px 0;display: inline"/>&ndash;&gt;-->
            <!--&lt;!&ndash;<span class="glyphicon glyphicon-arrow-right" style="color: red;font-size: 35px;"></span>&ndash;&gt;-->
            <!--<img src="__PUBLIC__/home/images/arrow-right.png" style="margin-top: -4px;width: 4em">-->
            <!--&lt;!&ndash; ->&ndash;&gt;-->
        <!--</div>-->
        <!--<div class="text-center col-xs-5" id="area_end_click" style="line-height: 40px;color: black;font-size: 1.2em;padding: 5px 0;">-->
            <!--<span id="area_end_html">点击选择</span>-->
            <!--&lt;!&ndash;<span id="area_end_remove" class="glyphicon glyphicon-remove"></span>&ndash;&gt;-->
            <!--<span id="area_end_remove" style="line-height: 40px">-->
                <!--<img src="__PUBLIC__/home/images/remove.png" style="margin-top: -4px;width: 1em">-->
            <!--</span>-->
            <!--<img src="__PUBLIC__/home/images/area_end_text.png" class="" style="height: 20px">-->
            <!--<div id="area_end" style="display: none"></div>-->
        <!--</div>-->
    <!--</div>-->
<!--</div>-->
<!--导航标签-->
<div class="panel-title" style=";margin:0;padding: 0;background-color: white;display: block;">
    <div class="weui_navbar" style="position: relative;">
        <span id="start_tag" class="area-search"
              style="width: 42%;display: inline-block;line-height: 40px;font-size: 1.2em">
            <img src="__PUBLIC__/home/images/area_start_text.png" class=""
                 style="z-index: 2;position: absolute;height: 20px;top: 25%;left: 2%;">
            <input readonly type="text" data-toggle="city-picker"
                   name="search_area_start" id="area_start"
                   style="width: 100%;padding:6px 12px;" value=""
                   placeholder="起始地">
        </span>
        <span id="change_tag" class="text-center mynavbar area-search" style="width: 15%;">
            <img src="__PUBLIC__/home/images/arrow-right.png" style="margin-top: 10px;width: 45px">
        </span>
        <span id="end_tag" class="area-search"
              style="width: 43%;display: inline-block;line-height: 40px;font-size: 1.2em">
            <img src="__PUBLIC__/home/images/area_end_text.png" class=""
                 style="z-index: 2;position: absolute;height: 20px;top: 25%;left: 94%;;">
            <input readonly type="text" data-toggle="city-picker"
                   name="search_area_end" id="area_end"
                   style="width: 100%;padding:6px 12px;" value=""
                   placeholder="目的地">
        </span>
    </div>
</div>

<!--订单展示栏-->
<div id="wrapper" style="top: 60px;margin-left: 2.5%;">
    <div id="scroller">
        <div id="pullDown">
            <span class="pullDownIcon" style="float: left"></span>
            <span class="pullDownLabel" style="margin-left: -48px">下拉刷新...</span>
        </div>
        <div class="tab-content">
            <ul id="search" class="tab-pane active" style=";list-style-type: none">
                <if condition="$none eq 'empty'">
                    <div class="text-center" style="color: red">
                        <img src="__PUBLIC__/home/images/no_more_message.jpg" style="width: 100%;">
                        <!--查询不到消息啦哈哈哈哈！-->
                    </div>
                </if>
                <volist name="message" id="data">
                    <div style=";background-color: white;border-radius: 5px;">
                        <table style="width: 100%" onclick="window.location.href='__MODULE__/OwnerOrder/wx_order_detail/id/'+{$data['message_id']};">
                            <tr>
                                <td></td>
                                <td class="help-block text-right" style="margin: 0">
                                    {$data['record_time']|substr=0,10}
                                </td>
                            </tr>
                            <tr>
                                <td style="padding: 0 10px;font-size: 1.2em">
                                    <img src="__PUBLIC__/home/images/area_start_text.png" class="" style="height: 20px">
                                    <span class="highlight">{$data['area_start_name']}</span>
                                </td>
                                <td rowspan="2" class="text-right" style="padding: 0 10px;font-size: 2em;color: red">
                                    ¥{$data['freight_price']}
                                </td>
                            </tr>
                            <tr>
                                <td style="padding: 0 10px;font-size: 1.2em">
                                    <img src="__PUBLIC__/home/images/area_end_text.png" class="" style="height: 20px">
                                    <span class="highlight">{$data['area_end_name']}</span>
                                </td>
                            </tr>
                        </table>
                        <hr style="margin: 8px 0">
                        <div style="margin-left: 3%;margin-bottom: 1%;padding-bottom: 2%">
                            <a href="tel:{$data.phone_number}" onclick='event.stopPropagation();' class="btn btn-default" style='padding: 3px;text-decoration: none;color: #04bfc6;border-color: #04bfc6'>
                                <span><img src="__PUBLIC__/home/images/phone.png" class="" style="width: 15px">
                                <span style="font-size: 1.2em">拨打电话</span></span>
                            </a>
                            <div class="pull-right" style="padding: 0 3px;">
                                <!--<span>-->
                                    <!--<img src="__PUBLIC__/home/images/useless.png" style="height: 30px" onclick="asd(this)">-->
                                    <!--<span style="color:#fb3e1e;margin-left: -3px" id="useful_count">123</span>-->
                                <!--</span>-->
                                <button style="padding: 4px 8px;margin-left: 12px;color: #04bfc6;border-color: #04bfc6" class="btn btn-default" data-toggle="modal" data-target="#feedback" data-whatever="{$data['id']}">报错</button>
                            </div>
                            <!--<button class="btn btn-default" style="background-color: red;color: blue;"><span class="glyphicon glyphicon-user"></span> asd</button>-->
                            <!--<div style="background: url('__PUBLIC__/home/images/useless.png') no-repeat;"></div>-->
                        </div>
                    </div>
                </volist>
            </ul>
        </div>
        <div id="pullUp">
            <span class="pullUpIcon"></span>
            <span class="pullUpLabel" style="margin-left: -48px">上拉加载更多...</span>
        </div>
    </div>
</div>
<!--克隆-->
<span id="cloneObj" style="display: none;">
    <div style=";background-color: white;border-radius: 5px;">
        <table style="width: 100%" onclick="window.location.href='__MODULE__/OwnerOrder/wx_order_detail/id/'+{$data['message_id']};">
            <tr>
                <td></td>
                <td class="help-block text-right" style="margin: 0">
                    {$data['record_time']|substr=0,10}
                </td>
            </tr>
            <tr>
                <td style="padding: 0 10px;font-size: 1.2em">
                    <img src="__PUBLIC__/home/images/area_start_text.png" class="" style="height: 20px">
                    <span class="highlight">{$data['area_start_name']}</span>
                </td>
                <td rowspan="2" class="text-right" style="padding: 0 10px;font-size: 2em;color: red">
                    ¥{$data['freight_price']}
                </td>
            </tr>
            <tr>
                <td style="padding: 0 10px;font-size: 1.2em">
                    <img src="__PUBLIC__/home/images/area_end_text.png" class="" style="height: 20px">
                    <span class="highlight">{$data['area_end_name']}</span>
                </td>
            </tr>
        </table>
        <hr style="margin: 8px 0">
        <div style="margin-left: 3%;margin-bottom: 1%;padding-bottom: 2%">
            <a href="tel:{$data.phone_number}" onclick='event.stopPropagation();' class="btn btn-default" style='padding: 3px;text-decoration: none;color: #04bfc6;border-color: #04bfc6'>
                                <span><img src="__PUBLIC__/home/images/phone.png" class="" style="width: 15px">
                                <span style="font-size: 1.2em">拨打电话</span></span>
            </a>
            <div class="pull-right" style="padding: 0 3px;">
                <!--<span>-->
                <!--<img src="__PUBLIC__/home/images/useless.png" style="height: 30px" onclick="asd(this)">-->
                <!--<span style="color:#fb3e1e;margin-left: -3px" id="useful_count">123</span>-->
                <!--</span>-->
                <button style="padding: 4px 8px;margin-left: 12px;color: #04bfc6;border-color: #04bfc6" class="btn btn-default" data-toggle="modal" data-target="#feedback" data-whatever="{$data['id']}">报错</button>
            </div>
            <!--<button class="btn btn-default" style="background-color: red;color: blue;"><span class="glyphicon glyphicon-user"></span> asd</button>-->
            <!--<div style="background: url('__PUBLIC__/home/images/useless.png') no-repeat;"></div>-->
        </div>
    </div>
</span>
<!-- Modal -->
<div class="modal fade bs-example-modal-lg" id="feedback" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog" style="top:30%">
        <div class="modal-content">
            <div class="modal-header" style="border: none">
                <button type="button" class="close" data-dismiss="modal">
                    <span aria-hidden="true">&times;</span>
                    <span class="sr-only">Close</span>
                </button>
                <h5 class="modal-title" id="myModalLabel" style="color: grey;">错误信息提交</h5>
            </div>
            <div class="modal-body" style="padding-top: 0;padding-bottom: 0">
                <input id="freight_id" name="freight_id" type="hidden">
                <textarea name="feedback" id="feedback_input" class="form-control" rows="5" placeholder="您可以输入报错信息，也可以直接提交" style="resize: none;width: 100%"></textarea>
            </div>
            <div class="modal-footer" style="border: none">
                <button id="feedback_submit" type="button" class="btn btn-primary" style="border-color: #ccc;background-color: #04bfc6">提交</button>
                <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
            </div>
        </div>
    </div>
</div>
</body>
<!--载入读取上次标签-->
<script>
    $(function () {
        var temp_load = cookie('freight_search');
        var temp_load_obj = JSON.parse(cookie('freight_search'));
        console.log(temp_load_obj);
        jQuery.each(temp_load_obj,function(k,val){
            if(val.name == 'area_start'){
                if(val.value != '') {
                    $('input[name=area_start]').val(val.value);
                }else{}
            }
            else if(val.name == 'area_start_name'){
                if(val.value != ''){
                    $('input[name=area_start_name]').val(val.value);
                    $('#area_start_html').html(val.value);
                }else{}
            }
            else if (val.name == 'area_start_val') {
                if (val.value != '') {
                    $('input[name=area_start_val]').val(val.value);
                    var AreaArr_start = val.value.split('/');
                    $('#area_start').citypicker('destroy');
                    $('#area_start').citypicker({
                        province: AreaArr_start[0],
                        city: AreaArr_start[1],
                        district: AreaArr_start[2],
                        area: AreaArr_start[3]
                    });
                } else {
                }
            }
            else if(val.name == 'area_end'){
                if(val.value != ''){
                    $('input[name=area_end]').val(val.value);
                }else{}
            }
            else if(val.name == 'area_end_name'){
                if(val.value != ''){
                    $('input[name=area_end_name]').val(val.value);
                    $('#area_end_html').html(val.value);
                }
            }
            else if (val.name == 'area_end_val') {
                if (val.value != '') {
                    $('input[name=area_end_val]').val(val.value);
                    var AreaArr_end = val.value.split('/');
                    $('#area_end').citypicker('destroy');
                    $('#area_end').citypicker({
                        province: AreaArr_end[0],
                        city: AreaArr_end[1],
                        district: AreaArr_end[2],
                        area: AreaArr_end[3]
                    });
                } else {
                }
            }
        });
        console.log('form');
        console.log(JSON.stringify($('#tag_search').serializeArray()));
        refresh_hl();
    });
</script>
<!--功能抽离用于不同情况刷新页面-->
<script>
    function requestAndRendering() {
        //获取表单数据
        var area_start = $('input[name=area_start]').val();
        var area_start_name = $('input[name=area_start_name]').val();
        var area_end = $('input[name=area_end]').val();
        var area_end_name = $('input[name=area_end_name]').val();
        $.ajax({
            type: "post",
            url: "{:U('FreightSearch/show')}",
            data: {
                isAjax: 1,
                area_start: area_start,
                area_start_name: area_start_name,
                area_end: area_end,
                area_end_name: area_end_name
            },
            beforeSend: function () {
                $('#loadingToast').show();
            },
            success: function (data) {
                console.log('success');
                var jsonObj = eval("(" + data + ")");
                console.log(jsonObj);
                $('#search').html('');
                $('#page').val(1);
                $.each(jsonObj.data,function(k,val){
                    var tempObj=$("#cloneObj").children("div").clone(true);
                    tempObj.children('table').attr('onclick',"window.location.href='__MODULE__/OwnerOrder/wx_order_detail/id/"+val.message_id+"';");
                    tempObj.children('table').children('tbody').children('tr').eq(0).children('td').eq(1).html(val.record_time.substr(0,10));
                    tempObj.children('table').children('tbody').children('tr').eq(1).children('td').eq(0).children('span').html(val.area_start_name);
                    tempObj.children('table').children('tbody').children('tr').eq(1).children('td').eq(1).html('¥'+val.freight_price);
                    tempObj.children('table').children('tbody').children('tr').eq(2).children('td').children('span').html(val.area_end_name);
                    tempObj.children('div').children('a').attr('href','tel:'+val.phone_number);
                    tempObj.children('div').children('div').children('button').attr('data-whatever',val.id);
                    tempObj.appendTo("#search");
                });
                myScroll.refresh();
                refresh_hl();
            },
            complete: function () {
                $('#loadingToast').hide();
            }
        });
        myScroll.refresh();
    }
</script>
<!--地址选择-->
<script>
    //点击地址选择标签
    $(document).on('render_flag', function () {
        console.log('rendering rendering');
        var area_tag = cookie('area_tag');
        var input, areaArr, area_start_name, area_start_id, area_end_name, area_end_id;
        var area_start, area_end;
        if (area_tag == 'start') {
            ck_log("click", "选择起始地");
            //取起始地的值
            input = $('#area_start');
            areaArr = input.val().split('/');
            area_start_name = areaArr[areaArr.length - 1];
            area_start_id = input.data('citypicker').getCode();
            //更新表单对应值
            $('input[name=area_start]').val(area_start_id);
            $('input[name=area_start_name]').val(area_start_name);
            $('input[name=area_start_val]').val(input.val());
            //更新页面cookie
            cookie('freight_search', JSON.stringify($('#tag_search').serializeArray()));
            //ajax请求并渲染页面
            requestAndRendering();
        } else if (area_tag == 'end') {
            ck_log("click", "选择目的地");
            //取目的地的值
            input = $('#area_end');
            areaArr = input.val().split('/');
            area_end_name = areaArr[areaArr.length - 1];
            area_end_id = input.data('citypicker').getCode();
            //更新表单对应值
            $('input[name=area_end]').val(area_end_id);
            $('input[name=area_end_name]').val(area_end_name);
            $('input[name=area_end_val]').val(input.val());
            //更新页面cookie
            cookie('freight_search', JSON.stringify($('#tag_search').serializeArray()));
            //ajax请求并渲染页面
            requestAndRendering();
        } else {
        }
    });
    //起始地
    $('#start_tag').click(function () {
        console.log('start_area click');
        cookie('area_tag', 'start');
    });
    //目的地
    $('#end_tag').click(function () {
        console.log('end_area click');
        cookie('area_tag', 'end');
    });
</script>

<!--点击地址选择(旧)-->
<script>
    //起始地
    $('#area_start_click').click(function () {
        var goto_url = "{:U('areaSearch/area_search')}";
        var current_url = window.location.href;
        cookie('start_or_end', 'start');
        cookie('last_url', current_url);
        //填写表单数据
        //更新页面cookie
        cookie('freight_search',JSON.stringify($('#tag_search').serializeArray()));
        //告诉area_search要改什么
        var source = {name:'freight_search',value:cookie('freight_search')};
        cookie('source',JSON.stringify(source));
        //地址跳转
        window.location.href = goto_url;
    });
    //目的地
    $('#area_end_click').click(function () {
        var goto_url = "{:U('areaSearch/area_search')}";
        var current_url = window.location.href;
        cookie('start_or_end', 'end');
        cookie('last_url', current_url);
        //填写表单数据
        //更新页面cookie
        cookie('freight_search',JSON.stringify($('#tag_search').serializeArray()));
        //告诉area_search要改什么
        var source = {name:'freight_search',value:cookie('freight_search')};
        cookie('source',JSON.stringify(source));
        //地址跳转
        window.location.href = goto_url;
    });
    //删除起始地
    $('#area_start_remove').click(function(event){
        event.stopPropagation();
        console.log('remove_start_area');
        //更改表单数据
        $('input[name=area_start]').val('');
        $('input[name=area_start_name]').val('');
        //更新页面cookie
        cookie('freight_search',JSON.stringify($('#tag_search').serializeArray()));
        //取表单数据
        var area_start = $('input[name=area_start]').val();
        var area_start_name = $('input[name=area_start_name]').val();
        var area_end = $('input[name=area_end]').val();
        var area_end_name = $('input[name=area_end_name]').val();
        $.ajax({
            type: "post",
            url: "{:U('FreightSearch/show')}",
            data: {
                isAjax: 1,
                area_start:area_start,
                area_start_name:area_start_name,
                area_end:area_end,
                area_end_name:area_end_name
            },
            success: function (data) {
                console.log('success');
                var jsonObj = eval("(" + data + ")");
                console.log(jsonObj);
                $('#search').html('');
                $('#area_start_html').html('点击选择');
                $('#page').val(1);
                $.each(jsonObj.data,function(k,val){
                    var tempObj=$("#cloneObj").children("div").clone(true);
                    tempObj.children('table').attr('onclick',"window.location.href='__MODULE__/OwnerOrder/wx_order_detail/id/"+val.message_id+"';");
                    tempObj.children('table').children('tbody').children('tr').eq(0).children('td').eq(1).html(val.record_time.substr(0,10));
                    tempObj.children('table').children('tbody').children('tr').eq(1).children('td').eq(0).children('span').html(val.area_start_name);
                    tempObj.children('table').children('tbody').children('tr').eq(1).children('td').eq(1).html('¥'+val.freight_price);
                    tempObj.children('table').children('tbody').children('tr').eq(2).children('td').children('span').html(val.area_end_name);
                    tempObj.children('div').children('a').attr('href','tel:'+val.phone_number);
                    tempObj.children('div').children('div').children('button').attr('data-whatever',val.id);
                    tempObj.appendTo("#search");
                });
                myScroll.refresh();
                refresh_hl();
                flag = true;
            }
        });
        myScroll.refresh();
    });
    //删除目的地
    $('#area_end_remove').click(function(event){
        event.stopPropagation();
        console.log('remove_end_area',flag);
        //更改表单数据
        $('input[name=area_end]').val('');
        $('input[name=area_end_name]').val('');
        //更新页面cookie
        cookie('freight_search',JSON.stringify($('#tag_search').serializeArray()));
        //取表单数据
        var area_start = $('input[name=area_start]').val();
        var area_start_name = $('input[name=area_start_name]').val();
        var area_end = $('input[name=area_end]').val();
        var area_end_name = $('input[name=area_end_name]').val();
        $.ajax({
            type: "post",
            url: "{:U('FreightSearch/show')}",
            data: {
                isAjax: 1,
                area_start:area_start,
                area_start_name:area_start_name,
                area_end:area_end,
                area_end_name:area_end_name
            },
            success: function (data) {
                console.log('success',flag);
                var jsonObj = eval("(" + data + ")");
                console.log(jsonObj);
                $('#search').html('');
                $('#area_end_html').html('点击选择');
                $('#page').val(1);
                $.each(jsonObj.data,function(k,val){
                    var tempObj=$("#cloneObj").children("div").clone(true);
                    tempObj.children('table').attr('onclick',"window.location.href='__MODULE__/OwnerOrder/wx_order_detail/id/"+val.message_id+"';");
                    tempObj.children('table').children('tbody').children('tr').eq(0).children('td').eq(1).html(val.record_time.substr(0,10));
                    tempObj.children('table').children('tbody').children('tr').eq(1).children('td').eq(0).children('span').html(val.area_start_name);
                    tempObj.children('table').children('tbody').children('tr').eq(1).children('td').eq(1).html('¥'+val.freight_price);
                    tempObj.children('table').children('tbody').children('tr').eq(2).children('td').children('span').html(val.area_end_name);
                    tempObj.children('div').children('a').attr('href','tel:'+val.phone_number);
                    tempObj.children('div').children('div').children('button').attr('data-whatever',val.id);
                    tempObj.appendTo("#search");
                });
                myScroll.refresh();
                refresh_hl();
                flag = true;
            }
        });
        myScroll.refresh();
    });

</script>
<!--滚动功能-->
<script>
    var flag = true;
    var myScroll, pullDownEl, pullDownOffset, pullUpEl, pullUpOffset;
    var time_now, update_time;
    /**下拉刷新 （自定义实现此方法）
     *myScroll.refresh(); // 数据加载完成后，调用界面更新方法
     */
    function pullDownAction() {
        console.log('down',flag);
        var area_start = $('input[name=area_start]').val();
        var area_start_name = $('input[name=area_start_name]').val();
        var area_end = $('input[name=area_end]').val();
        var area_end_name = $('input[name=area_end_name]').val();
        $.ajax({
            type: "post",
            url: "{:U('FreightSearch/show')}",
            data: {
                isAjax: 1,
                area_start:area_start,
                area_start_name:area_start_name,
                area_end:area_end,
                area_end_name:area_end_name
            },
            success: function (data) {
                console.log('success',flag);
                var jsonObj = eval("(" + data + ")");
                console.log(jsonObj);
                $('#search').html('');
                $('#page').val(1);
                $.each(jsonObj.data,function(k,val){
                    var tempObj=$("#cloneObj").children("div").clone(true);
                    tempObj.children('table').attr('onclick',"window.location.href='__MODULE__/OwnerOrder/wx_order_detail/id/"+val.message_id+"';");
                    tempObj.children('table').children('tbody').children('tr').eq(0).children('td').eq(1).html(val.record_time.substr(0,10));
                    tempObj.children('table').children('tbody').children('tr').eq(1).children('td').eq(0).children('span').html(val.area_start_name);
                    tempObj.children('table').children('tbody').children('tr').eq(1).children('td').eq(1).html('¥'+val.freight_price);
                    tempObj.children('table').children('tbody').children('tr').eq(2).children('td').children('span').html(val.area_end_name);
                    tempObj.children('div').children('a').attr('href','tel:'+val.phone_number);
                    tempObj.children('div').children('div').children('button').attr('data-whatever',val.id);
                    tempObj.appendTo("#search");
                });
                myScroll.refresh();
                refresh_hl();
                flag = true;
            }
        });
        myScroll.refresh();//数据加载完成后，调用界面更新方法  Remember to refresh when contents are loaded (ie: on ajax completion)
    }
    /**滚动翻页 （自定义实现此方法）
     *myScroll.refresh(); // 数据加载完成后，调用界面更新方法
     */
    function pullUpAction() {
        console.log('up',flag);
        var a = $('#tag_search').serialize();
        var area_start = $('input[name=area_start]').val();
        var area_start_name = $('input[name=area_start_name]').val();
        var area_end = $('input[name=area_end]').val();
        var area_end_name = $('input[name=area_end_name]').val();
        var page = $('#page').val();
        console.log('cur_page',page);
        var request_page = parseInt(page) + 1;
        console.log('rq_page',request_page);
        $.ajax({
            type: "post",
            url: "{:U('FreightSearch/show_more')}",
            data: {
                area_start:area_start,
                area_start_name:area_start_name,
                area_end:area_end,
                area_end_name:area_end_name,
                page:request_page
            },
            success: function (data) {
                console.log('success',flag);
                var jsonObj = eval("(" + data + ")");
                console.log(jsonObj);
                $.each(jsonObj.data,function(k,val){
                    var tempObj=$("#cloneObj").children("div").clone(true);
                    tempObj.children('table').attr('onclick',"window.location.href='__MODULE__/OwnerOrder/wx_order_detail/id/"+val.message_id+"';");
                    tempObj.children('table').children('tbody').children('tr').eq(0).children('td').eq(1).html(val.record_time.substr(0,10));
                    tempObj.children('table').children('tbody').children('tr').eq(1).children('td').eq(0).children('span').html(val.area_start_name);
                    tempObj.children('table').children('tbody').children('tr').eq(1).children('td').eq(1).html('¥'+val.freight_price);
                    tempObj.children('table').children('tbody').children('tr').eq(2).children('td').children('span').html(val.area_end_name);
                    tempObj.children('div').children('a').attr('href','tel:'+val.phone_number);
                    tempObj.children('div').children('div').children('button').attr('data-whatever',val.id);
                    tempObj.appendTo("#search");
                });
                if(jsonObj.end_tag == 'end'){
                    if(flag){
                        var div = document.createElement('div');
                        div.style.cssText = 'margin-top:2.5%;color:red;text-align:center';
                        div.innerHTML = '小矿查不到更多消息啦!';
                        document.getElementById('search').appendChild(div);
                        flag = false;
                    }
                    $('#page').val(jsonObj.page);
                }else if(jsonObj.end_tag == 'continue'){
                    $('#page').val(jsonObj.page);
                }
                myScroll.refresh();
                refresh_hl();
            }
        });
        //============================================
        myScroll.refresh(); // 数据加载完成后，调用界面更新方法 Remember to refresh when contents are loaded (ie: on ajax completion)
    }
    /**
     * 初始化iScroll控件
     */
    function loaded() {
        pullDownEl = document.getElementById('pullDown');
        pullDownOffset = pullDownEl.offsetHeight;
        pullUpEl = document.getElementById('pullUp');
        pullUpOffset = pullUpEl.offsetHeight;
//        console.log(pullDownOffset);
//        console.log(pullUpOffset);
        setTimeout(function () {
            myScroll = new iScroll('wrapper', {
//        scrollbarClass: 'myScrollbar', /* 重要样式 */
                useTransition: true,
                topOffset: pullDownOffset,
//        probeType: 3,
//        mouseWheel: false,
                scrollbars: true,
//                vScrollbar:false,
//        disableMouse: false,
//        disablePointer: false,
                //点击事件
                click: false,
                taps: false,
//        tap: true,
                preventDefault: false,//（把这句加上去哦）
                preventDefaultException: {tagName: /^(INPUT|TEXTAREA|BUTTON|SELECT|A)$/},
                onRefresh: function () {
                    console.log('refresh');
                    if (pullDownEl.className.match('loading')) {
                        pullDownEl.className = '';
                        pullDownEl.querySelector('.pullDownLabel').innerHTML = '下拉刷新...';
//                pullDownEl.querySelector('.pullDownLabel').innerHTML = '数据更新时间：' + update_time+'下拉刷新';
                    } else if (pullUpEl.className.match('loading')) {
                        pullUpEl.className = '';
                        pullUpEl.querySelector('.pullUpLabel').innerHTML = '上拉加载更多...';
                    }
                    document.getElementById("pullUp").style.display = "none";
                    time_now = new Date();
                    update_time = time_now.toLocaleString();
//            document.getElementById("show").innerHTML="onRefresh: up["+pullUpEl.className+"],down["+pullDownEl.className+"],Y["+this.y+"],maxScrollY["+this.maxScrollY+"],minScrollY["+this.minScrollY+"],scrollerH["+this.scrollerH+"],wrapperH["+this.wrapperH+"]";

                },
                onScrollMove: function () {
//            document.getElementById("show").innerHTML="onScrollMove: up["+pullUpEl.className+"],down["+pullDownEl.className+"],Y["+this.y+"],maxScrollY["+this.maxScrollY+"],minScrollY["+this.minScrollY+"],scrollerH["+this.scrollerH+"],wrapperH["+this.wrapperH+"]";
                    if (this.y > 0) {
                        pullDownEl.className = 'flip';
                        pullDownEl.querySelector('.pullDownLabel').innerHTML = '松手开始更新...</br>' + '最后更新时间：' + update_time;
                        this.minScrollY = 0;
                    }
                    if (this.y < 0 && pullDownEl.className.match('flip')) {
                        pullDownEl.className = '';
                        pullDownEl.querySelector('.pullDownLabel').innerHTML = '下拉刷新...';
                        this.minScrollY = -pullDownOffset;
                    }

                    if (this.scrollerH < this.wrapperH && this.y < (this.minScrollY - pullUpOffset) || this.scrollerH > this.wrapperH && this.y < (this.maxScrollY - pullUpOffset)) {
                        document.getElementById("pullUp").style.display = "";
                        pullUpEl.className = 'flip';
                        pullUpEl.querySelector('.pullUpLabel').innerHTML = '松手开始更新...</br>' + '最后更新时间：' + update_time;
                    }
                    if (this.scrollerH < this.wrapperH && this.y > (this.minScrollY - pullUpOffset) && pullUpEl.className.match('flip') || this.scrollerH > this.wrapperH && this.y > (this.maxScrollY - pullUpOffset) && pullUpEl.className.match('flip')) {
                        document.getElementById("pullUp").style.display = "none";
                        pullUpEl.className = '';
                        pullUpEl.querySelector('.pullUpLabel').innerHTML = '上拉加载更多...';
                    }
                },
                onScrollEnd: function () {
//            document.getElementById("show").innerHTML="onScrollEnd: up["+pullUpEl.className+"],down["+pullDownEl.className+"],Y["+this.y+"],maxScrollY["+this.maxScrollY+"],minScrollY["+this.minScrollY+"],scrollerH["+this.scrollerH+"],wrapperH["+this.wrapperH+"]";
                    if (pullDownEl.className.match('flip')) {
                        pullDownEl.className = 'loading';
                        pullDownEl.querySelector('.pullDownLabel').innerHTML = '加载中...';
                        pullDownAction(); // Execute custom function (ajax call?)
                    } else if (pullUpEl.className.match('flip')) {
                        pullUpEl.className = 'loading';
                        pullUpEl.querySelector('.pullUpLabel').innerHTML = '加载中...';
                        pullUpAction(); // Execute custom function (ajax call?)
                    }
                }
            });
            console.dir(myScroll.options);
        }, 100);
//    setTimeout(function(){
//        document.getElementById('wrapper').style.left = '0';
//    },800);
    }
    //初始化绑定iScroll控件
    document.addEventListener('touchmove', function (e) {
        e.preventDefault();
    }, false);
    document.addEventListener('DOMContentLoaded', loaded, false);
    //    window.onload = loaded()
</script>
<!--点赞功能-->
<script>
    function asd(obj) {
        var count = parseInt($(obj).siblings('span').html());
        if ($(obj).attr('src') == "__PUBLIC__/home/images/useless.png") {
            $(obj).attr("src", "__PUBLIC__/home/images/usefull.png");
//            $.ajax({
//                type: "post",
//                url: "{:U('FreightSearch/VoteCount')}",
//                data: {message_id:id,vote: 'Upvote',count:count},
//                success: function (data) {
//
//                },
//                error: function (XMLHttpRequest, textStatus, errorThrown) {
//                }
//            });
            count += 1;
            $(obj).siblings('span').html(count);
            console.log(count);

        } else {
            $(obj).attr("src", "__PUBLIC__/home/images/useless.png");
            count -= 1;
            $(obj).siblings('span').html(count);
            console.log(count);
        }
    }
</script>
<!--报错功能-->
<script>
    //自动对焦
    $('#feedback').on('shown.bs.modal', function (event) {
        $('#feedback_input').focus();
        var button = $(event.relatedTarget);
        var recipient = button.data('whatever');
        var modal = $(this);
//        modal.find('.modal-title').text('New message to ' + recipient);
        modal.find('.modal-body input').val(recipient)
    });
    $('#feedback_submit').click(function(){
        var freight_id = $('#freight_id').val();
        var content = $('#feedback_input').val();
        var feedback_string = '运费ID为'+freight_id+"的报错信息:"+content;
        $.ajax({
            type: "post",
            url: "{:U('Feedback/feedback_action')}",
            data: {
                contact:freight_id,
                feedback:feedback_string
            },
            success: function (data) {
                $('#feedback').modal('hide');
            }
        });
    });

</script>

<!--高亮-->
<script>

    function refresh_hl() {
        var keywords = [];

        var str = $('input[name=area_start_name]').val();
        keywords.push(str ? str : '');
        str = $('input[name=area_end_name]').val();
        keywords.push(str ? str : '');
        show_highlight(keywords);
    }

    function replace_with_highlight(str, keyword){
        if (keyword=='') return str;
        keyword=keyword.replace(new RegExp("市|区|县|镇",'gm'),'');
        return str.replace(new RegExp(keyword,'gm'),'<span style="background-color: orange; font-weight: bold">'+keyword+"</span>");
    }

    function show_highlight(keywords){
        function show_hl_by_element(element){
            var str = element.innerHTML;
            element.innerHTML = keywords.reduce(replace_with_highlight,str);
        }
        collectionToArray(document.getElementsByClassName('highlight')).map(show_hl_by_element);
//    $('.highlight').map(show_hl_by_element);

    }

    function collectionToArray(collection){
        var ary = [];
        for(var i=0, len = collection.length; i < len; i++){
            ary.push(collection[i]);
        }
        return ary;
    }
</script>